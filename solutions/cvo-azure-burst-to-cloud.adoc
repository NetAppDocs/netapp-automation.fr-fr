---
sidebar: sidebar 
permalink: solutions/cvo-azure-burst-to-cloud.html 
keywords: bluexp automation catalog, netapp automation solutions, azure, cloud volumes ontap, burst to cloud 
summary: 'Vous pouvez utiliser cette solution d"automatisation pour d√©ployer Cloud Volumes ONTAP pour Azure √† l"aide de Terraform.' 
---
= Cloud Volumes ONTAP pour Azure : en rafale vers le cloud
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ./media/


[role="lead"]
Cet article pr√©sente la solution d'automatisation NetApp Cloud Volumes ONTAP pour Azure, disponible aupr√®s des clients NetApp depuis le catalogue d'automatisation BlueXP¬†.

La solution d'automatisation Cloud Volumes ONTAP pour Azure automatise le d√©ploiement conteneuris√© d'Cloud Volumes ONTAP pour Azure √† l'aide de Terraform, ce qui vous permet de d√©ployer rapidement Cloud Volumes ONTAP pour Azure sans aucune intervention manuelle.

.Avant de commencer
* Vous devez t√©l√©charger la link:https://console.bluexp.netapp.com/automationCatalog["Cloud Volumes ONTAP Azure : en rafale vers le cloud"^]solution d'automatisation via l'interface utilisateur Web de BlueXP¬†. La solution est fournie en tant que `CVO-Azure-Burst-To-Cloud.zip`.
* Vous devez installer une machine virtuelle Linux sur le m√™me r√©seau que Cloud Volumes ONTAP.
* Apr√®s avoir install√© la machine virtuelle Linux, vous devez suivre les √©tapes de cette solution pour installer les d√©pendances requises.




== √âtape 1 : installez Docker et Docker compose



=== Installez Docker

Les √©tapes suivantes utilisent le logiciel de distribution Ubuntu 20.04 Debian Linux comme exemple. Les commandes que vous ex√©cutez d√©pendent du logiciel de distribution Linux que vous utilisez. Reportez-vous √† la documentation sp√©cifique du logiciel de distribution Linux pour votre configuration.

.√âtapes
. Installez Docker en ex√©cutant les commandes suivantes `sudo` :
+
[source, cli]
----
sudo apt-get update
sudo apt-get install apt-transport-https cacertificates curl gnupg-agent software-properties-common curl -fsSL https://download.docker.com/linux/ubuntu/gpg |
sudo apt-key add -
sudo add-apt-repository ‚Äúdeb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable‚Äù
sudo apt-get update
sudo apt-get install dockerce docker-ce-cli containerd.io
----
. V√©rifiez l'installation :
+
[source, cli]
----
docker ‚Äìversion
----
. V√©rifiez qu'un groupe nomm√© ¬´ docker ¬ª a √©t√© cr√©√© sur votre syst√®me Linux. Si n√©cessaire, cr√©ez le groupe :
+
[source, cli]
----
sudo groupadd docker
----
. Ajoutez l'utilisateur qui doit acc√©der √† Docker au groupe :
+
[source, cli]
----
sudo usermod -aG docker $(whoami)
----
. Vos modifications sont appliqu√©es une fois que vous vous √™tes d√©connecter et que vous vous √™tes de nouveau connect√© au terminal. Vous pouvez √©galement appliquer les modifications imm√©diatement :
+
[source, cli]
----
newgrp docker
----




=== Installez Docker compose

.√âtapes
. Installez Docker compose en ex√©cutant les commandes suivantes `sudo` :
+
[source, cli]
----
sudo curl -L ‚Äúhttps://github.com/docker/compose/releases/download/1.29.2/dockercompose-(ùë¢ùëõùëéùëöùëí ‚àí ùë†)‚àí(uname -m)‚Äù -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose
----
. V√©rifiez l'installation :
+
[source, cli]
----
docker-compose ‚Äìversion
----




== √âtape 2 : pr√©parez l'image Docker

.√âtapes
. Copiez le `CVO-Azure-Burst-To-Cloud.zip` dossier sur la machine virtuelle Linux que vous souhaitez utiliser pour d√©ployer Cloud Volumes ONTAP :
+
[source, cli]
----
scp -i ~/<private-key>.pem -r CVO-Azure-Burst-To-Cloud.zip <azureuser>@<IP_ADDRESS_OF_VM>:<LOCATION_TO_BE_COPIED>
----
+
** `private-key.pem` est votre fichier de cl√© priv√©e pour la connexion sans mot de passe.
** `azureuser` Est le nom d'utilisateur de la machine virtuelle.
** `IP_ADDRESS_OF_VM` Est l'adresse IP de la machine virtuelle.
** `LOCATION_TO_BE_COPIED` est l'emplacement o√π le dossier sera copi√©.


. Extraire le `CVO-Azure-Burst-To-Cloud.zip` dossier. Vous pouvez extraire le dossier dans le r√©pertoire actuel ou dans un emplacement personnalis√©.
+
Pour extraire le dossier dans le r√©pertoire actuel, ex√©cutez :

+
[source, cli]
----
unzip CVO-Azure-Burst-To-Cloud.zip
----
+
Pour extraire le dossier dans un emplacement personnalis√©, ex√©cutez :

+
[source, cli]
----
unzip CVO-Azure-Burst-To-Cloud.zip -d ~/<your_folder_name>
----
. Une fois le contenu extrait, acc√©dez au `CVO_Azure_Deployment` dossier et ex√©cutez la commande suivante pour afficher les fichiers :
+
[source, cli]
----
 ls -la
----
+
Vous devriez voir une liste de fichiers, similaire √† l'exemple suivant :

+
[listing]
----
drwxr-xr-x@ 11 user1 staff 352 May 5 13:56 .
drwxr-xr-x@ 5 user1 staff 160 May 5 14:24 ..
-rw-r--r--@ 1 user1 staff 324 May 5 13:18 .env
-rw-r--r--@ 1 user1 staff 1449 May 5 13:18 Dockerfile
-rw-r--r--@ 1 user1 staff 35149 May 5 13:18 LICENSE
-rw-r--r--@ 1 user1 staff 13356 May 5 14:26 README.md
-rw-r--r-- 1  user1 staff 354318151 May 5 13:51 cvo_azure_flexcache_ubuntu_image_latest
drwxr-xr-x@ 4 user1 staff 128 May 5 13:18 cvo_azure_variables
-rw-r--r--@ 1 user1 staff 996 May 5 13:18 docker-compose-deploy.yml
-rw-r--r--@ 1 user1 staff 1041 May 5 13:18 docker-compose-destroy.yml
-rw-r--r--@ 1 user1 staff 4771 May 5 13:18 sp_role.json
----
. Localisez le `cvo_azure_flexcache_ubuntu_image_latest.tar.gz` fichier. Ce document contient l'image Docker requise pour d√©ployer Cloud Volumes ONTAP pour Azure.
. D√©compressez le fichier :
+
[source, cli]
----
docker load -i cvo_azure_flexcache_ubuntu_image_latest.tar.gz
----
. Attendez quelques minutes que l'image Docker se charge, puis v√©rifiez que l'image Docker a bien √©t√© charg√©e :
+
[source, cli]
----
docker images
----
+
Vous devez voir une image Docker nomm√©e `cvo_azure_flexcache_ubuntu_image_latest` avec la `latest` balise, comme dans l'exemple suivant :

+
[listing]
----
REPOSITORY TAG IMAGE ID CREATED SIZE
cvo_azure_flexcache_ubuntu_image latest 18db15a4d59c 2 weeks ago 1.14GB
----




== √âtape 3 : cr√©ation de fichiers de variables d'environnement

√Ä ce stade, vous devez cr√©er deux fichiers de variables d'environnement. Un fichier est destin√© √† l'authentification des API Azure Resource Manager √† l'aide des informations d'identification principales du service. Le second fichier sert √† d√©finir des variables d'environnement afin que les modules BlueXP¬† Terraform puissent localiser et authentifier les API Azure.

.√âtapes
. Cr√©ez une entit√© de service.
+
Avant de pouvoir cr√©er les fichiers de variables d'environnement, vous devez cr√©er une entit√© de service en suivant les √©tapes de la section link:https://learn.microsoft.com/en-us/azure/active-directory/develop/howto-create-service-principal-portal["Cr√©ez une application Azure Active Directory et une entit√© de service pouvant acc√©der aux ressources"^].

. Attribuez le r√¥le *Contributor* √† l'entit√© de service nouvellement cr√©√©e.
. Cr√©ez un r√¥le personnalis√©.
+
.. Recherchez le `sp_role.json` fichier et v√©rifiez les autorisations requises sous les actions r√©pertori√©es.
.. Ins√©rez ces autorisations et associez le r√¥le personnalis√© au principal de service nouvellement cr√©√©.


. Naviguez jusqu'√† *certificats et secrets* et s√©lectionnez *Nouveau secret client* pour cr√©er le secret client.
+
Lorsque vous cr√©ez le secret client, vous devez enregistrer les d√©tails de la colonne *valeur* car vous ne pourrez plus voir cette valeur. Vous devez √©galement enregistrer les informations suivantes :

+
** ID client
** ID d'abonnement
** ID locataire
+
Vous aurez besoin de ces informations pour cr√©er les variables d'environnement. Vous trouverez des informations sur l'ID client et l'ID locataire dans la section *Pr√©sentation* de l'interface utilisateur principale du service.



. Cr√©ez les fichiers d'environnement.
+
.. Cr√©ez le `azureauth.env` fichier √† l'emplacement suivant :
+
`path/to/env-file/azureauth.env`

+
... Ajoutez le contenu suivant au fichier :
+
ClientID=<> clientSecret=<> subscriptionId=<> tenantId=<>

+
Le format *doit* doit √™tre exactement comme indiqu√© ci-dessus, sans espace entre la cl√© et la valeur.



.. Cr√©ez le `credentials.env` fichier √† l'emplacement suivant :
+
`path/to/env-file/credentials.env`

+
... Ajoutez le contenu suivant au fichier :
+
AZURE_TENANT_ID=<> AZURE_CLIENT_SECRET=<> AZURE_CLIENT_ID=<> AZURE_SUBSCRIPTION_ID=<>

+
Le format *doit* doit √™tre exactement comme indiqu√© ci-dessus, sans espace entre la cl√© et la valeur.





. Ajoutez les chemins de fichier absolus au `.env` fichier.
+
Entrez le chemin absolu du `azureauth.env` fichier d'environnement dans le `.env` fichier correspondant √† la `AZURE_RM_CREDS` variable d'environnement.

+
`AZURE_RM_CREDS=path/to/env-file/azureauth.env`

+
Entrez le chemin absolu du `credentials.env` fichier d'environnement dans le `.env` fichier correspondant √† la `BLUEXP_TF_AZURE_CREDS` variable d'environnement.

+
`BLUEXP_TF_AZURE_CREDS=path/to/env-file/credentials.env`





== √âtape 4 : ajoutez des licences Cloud Volumes ONTAP √† BlueXP¬† ou abonnez-vous √† BlueXP¬†

Vous pouvez ajouter des licences Cloud Volumes ONTAP √† BlueXP¬† ou vous abonner √† NetApp BlueXP¬† sur Azure Marketplace.

.√âtapes
. Sur le portail Azure, acc√©dez √† *SaaS* et s√©lectionnez *s'abonner √† NetApp BlueXP¬†*.
. S√©lectionnez le plan *Cloud Manager (par Cap PYGO par heure, WORM et services de donn√©es)*.
+
Vous pouvez utiliser le m√™me groupe de ressources que Cloud Volumes ONTAP ou un autre groupe de ressources.

. Configurez le portail BlueXP¬† pour importer l'abonnement SaaS vers BlueXP¬†.
+
Vous pouvez le configurer directement √† partir du portail Azure en acc√©dant √† *D√©tails du produit et du plan* et en s√©lectionnant l'option *configurer le compte maintenant*.

+
Vous serez ensuite redirig√© vers le portail BlueXP¬† pour confirmer la configuration.

. Confirmez la configuration dans le portail BlueXP¬† en s√©lectionnant *Enregistrer*.




== √âtape 5 : cr√©er un volume externe

Vous devez cr√©er un volume externe pour conserver les fichiers d'√©tat Terraform et d'autres fichiers importants persistants. Vous devez vous assurer que les fichiers sont disponibles pour Terraform pour ex√©cuter le workflow et les d√©ploiements.

.√âtapes
. Cr√©er un volume externe en dehors de Docker compose :
+
[source, cli]
----
docker volume create ¬´ volume_name ¬ª
----
+
Exemple :

+
[listing]
----
docker volume create cvo_azure_volume_dst
----
. Utilisez l'une des options suivantes :
+
.. Ajoutez un chemin de volume externe au `.env` fichier d'environnement.
+
Vous devez suivre le format exact indiqu√© ci-dessous.

+
Format :

+
`PERSISTENT_VOL=path/to/external/volume:/cvo_azure`

+
Exemple :
`PERSISTENT_VOL=cvo_azure_volume_dst:/cvo_azure`

.. Ajoutez des partages NFS comme volume externe.
+
Assurez-vous que le conteneur Docker peut communiquer avec les partages NFS et que les autorisations appropri√©es, telles que lecture/√©criture, sont configur√©es.

+
... Ajoutez le chemin des partages NFS comme chemin d'acc√®s au volume externe dans le fichier Docker compose, comme illustr√© ci-dessous : format :
+
`PERSISTENT_VOL=path/to/nfs/volume:/cvo_azure`

+
Exemple :
`PERSISTENT_VOL=nfs/mnt/document:/cvo_azure`





. Acc√©dez au `cvo_azure_variables` dossier.
+
Vous devriez voir les fichiers de variables suivants dans le dossier :

+
`terraform.tfvars`

+
`variables.tf`

. Modifiez les valeurs √† l'int√©rieur du `terraform.tfvars` fichier en fonction de vos besoins.
+
Vous devez lire la documentation sp√©cifique lors de la modification de l'une des valeurs de variable du `terraform.tfvars` fichier. Ces valeurs peuvent varier en fonction de la r√©gion, des zones de disponibilit√© et d'autres facteurs pris en charge par Cloud Volumes ONTAP pour Azure. Notamment les licences, la taille des disques et la taille des machines virtuelles pour les n≈ìuds uniques et les paires haute disponibilit√©.

+
Toutes les variables de support pour les modules Connector et Cloud Volumes ONTAP Terraform sont d√©j√† d√©finies dans le `variables.tf` fichier. Vous devez vous r√©f√©rer aux noms de variable dans le `variables.tf` fichier avant de l'ajouter au `terraform.tfvars` fichier.

. Selon vos besoins, vous pouvez activer ou d√©sactiver FlexCache et FlexClone en d√©finissant les options suivantes sur `true` ou `false`.
+
Les exemples suivants activent FlexCache et FlexClone :

+
** `is_flexcache_required = true`
** `is_flexclone_required = true`


. Si n√©cessaire, vous pouvez r√©cup√©rer la valeur de la variable Terraform `az_service_principal_object_id` √† partir du service Azure Active Directory :
+
.. Acc√©dez √† *applications d'entreprise ‚Äì> toutes les applications* et s√©lectionnez le nom du principal de service que vous avez cr√©√© pr√©c√©demment.
.. Copiez l'ID d'objet et ins√©rez la valeur de la variable Terraform :
+
`az_service_principal_object_id`







== √âtape 6 : d√©ploiement de Cloud Volumes ONTAP pour Azure

Proc√©dez comme suit pour d√©ployer Cloud Volumes ONTAP pour Azure.

.√âtapes
. Depuis le dossier racine, ex√©cutez la commande suivante pour d√©clencher le d√©ploiement :
+
[source, cli]
----
docker-compose up -d
----
+
Deux conteneurs sont d√©clench√©s, le premier conteneur d√©ploie Cloud Volumes ONTAP et le second envoie des donn√©es de t√©l√©m√©trie √† AutoSupport.

+
Le deuxi√®me conteneur attend jusqu'√† ce que le premier conteneur termine toutes les √©tapes avec succ√®s.

. Surveiller la progression du processus de d√©ploiement √† l'aide des fichiers journaux :
+
[source, cli]
----
docker-compose logs -f
----
+
Cette commande fournit des r√©sultats en temps r√©el et capture les donn√©es dans les fichiers journaux suivants :

+
`deployment.log`

+
`telemetry_asup.log`

+
Vous pouvez modifier le nom de ces fichiers journaux en modifiant le `.env` fichier √† l'aide des variables d'environnement suivantes :

+
`DEPLOYMENT_LOGS`

+
`TELEMETRY_ASUP_LOGS`

+
Les exemples suivants montrent comment modifier les noms des fichiers journaux :

+
`DEPLOYMENT_LOGS=<your_deployment_log_filename>.log`

+
`TELEMETRY_ASUP_LOGS=<your_telemetry_asup_log_filename>.log`



.Une fois que vous avez termin√©
Vous pouvez utiliser les √©tapes suivantes pour supprimer l'environnement temporaire et nettoyer les √©l√©ments cr√©√©s pendant le processus de d√©ploiement.

.√âtapes
. Si vous avez d√©ploy√© FlexCache, d√©finissez l'option suivante dans le `terraform.tfvars` fichier, cela nettoie les volumes FlexCache et supprime l'environnement temporaire cr√©√© pr√©c√©demment.
+
`flexcache_operation = "destroy"`

+

NOTE: Les options possibles sont  `deploy` et `destroy`.

. Si vous avez d√©ploy√© FlexClone, d√©finissez l'option suivante dans le `terraform.tfvars` fichier, cela nettoie les volumes FlexClone et supprime l'environnement temporaire cr√©√© pr√©c√©demment.
+
`flexclone_operation = "destroy"`

+

NOTE: Les options possibles sont `deploy` et `destroy`.


